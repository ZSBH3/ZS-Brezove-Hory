<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Informační tabule — ZŠ Březové Hory</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
  :root{
    --bg1:#08272d; --bg2:#0e3b46; --accent:#ff8a3d;
    --accent-2:#ffd9b8; --glass: rgba(255,255,255,0.04);
    --card:#0b2530; --muted:#9fb0bd;
    --radius:18px; --gap:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#eaf2f5}
  body{display:flex;align-items:center;justify-content:center;padding:12px}
  .board{
    width:100%; max-width:2400px; height:96vh;
    display:grid;
    grid-template-columns: 1.4fr 1fr 1fr;
    grid-template-rows: auto 1fr;
    gap:var(--gap);
    padding:22px;
    border-radius:22px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: 0 26px 100px rgba(0,0,0,0.6);
    overflow:hidden;
  }

  /* Topbar */
  .topbar{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;padding:6px 16px}
  .title{display:flex;gap:14px;align-items:center}
  .logo{width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,#00b3a6,#045a63);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:28px;color:white;box-shadow:0 8px 26px rgba(0,0,0,0.5)}
  .school-name{font-size:26px;font-weight:700;color:#ffefdc}
  .meta{color:var(--muted);font-size:13px}

  /* Card base */
  .card{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.03); display:flex; flex-direction:column; gap:12px;}
  .card-header{display:flex;gap:12px;align-items:center}
  .card-header .icon{font-size:26px;color:var(--accent)}
  .card-header h3{margin:0;color:var(--accent-2);font-size:18px}
  .meta-small{color:var(--muted);font-size:13px}

  /* Layout areas */
  .left-top{grid-column:1/2;grid-row:1/2;display:grid;grid-template-columns:1fr;gap:var(--gap)}
  .center-top{grid-column:2/3;grid-row:1/2;display:flex;flex-direction:column;gap:var(--gap)}
  .right-top{grid-column:3/4;grid-row:1/2;display:flex;flex-direction:column;gap:var(--gap)}

  .left-bottom{grid-column:1/2;grid-row:2/3;display:flex;flex-direction:column;gap:var(--gap)}
  .center-bottom{grid-column:2/4;grid-row:2/3;display:flex;flex-direction:column;gap:var(--gap)}

  /* Clock & time */
  .clock-large{display:flex;flex-direction:column;gap:8px}
  #clock-time{font-size:64px;font-weight:800;letter-spacing:1px}
  #clock-date{color:var(--muted);font-size:16px}

  /* Progress / schedule */
  .progress-row{display:flex;align-items:center;gap:12px;margin-top:6px}
  .time-left{width:140px;font-weight:800;color:var(--accent-2);font-size:18px}
  .progress-track{flex:1;height:20px;background:rgba(255,255,255,0.03);border-radius:12px;overflow:hidden}
  .progress-fill{height:100%;width:0%;background:linear-gradient(90deg,#48d07b,#ffb86b);transition:width 0.4s linear}
  .time-end{width:90px;text-align:right;font-weight:700;color:var(--accent-2);font-size:16px}
  .block-info{color:var(--muted);font-size:14px;margin-top:6px}

  /* Weather */
  .weather-day{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.01)}
  .weather-main{font-weight:700}
  .weather-sub{color:var(--muted);font-size:13px}
  .weather-icon{font-size:28px}

  /* lunch */
  #obed{overflow:auto;max-height:420px;padding-right:6px}
  .meal{padding:10px;border-radius:10px;margin-bottom:8px;background:linear-gradient(90deg, rgba(255,255,255,0.012), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}

  /* departures */
  .departures{display:flex;flex-direction:column;gap:12px;max-height:520px;overflow:auto}
  .stop-block{padding:12px;border-radius:10px;background:rgba(255,255,255,0.012)}
  .stop-name{font-weight:800;color:var(--accent-2);margin-bottom:8px}
  .dep-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}
  .dep-left{font-weight:700}
  .dep-time{color:var(--accent-2);font-weight:800}
  .small-meta{font-size:12px;color:var(--muted)}

  /* news */
  .news-item{display:flex;gap:10px;align-items:flex-start;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}

  /* ticker: left -> right (user wanted left -> right) */
  .ticker{grid-column:1/-1;height:52px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;align-items:center;overflow:hidden;padding:6px 12px;border:1px solid rgba(255,255,255,0.03)}
  .marquee{white-space:nowrap;display:inline-block; transform:translate3d(-100%,0,0); animation:marq 28s linear infinite}
  @keyframes marq{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

  .live-clock-badge{position:fixed;right:24px;bottom:24px;background:var(--accent);color:#081018;padding:10px 14px;border-radius:12px;font-weight:800;box-shadow:0 12px 36px rgba(0,0,0,0.6);z-index:40}

  @media (max-width:1400px){
    #clock-time{font-size:44px}
  }
  @media (max-width:900px){
    .board{grid-template-columns:1fr;grid-template-rows:auto auto 1fr auto}
    .center-bottom{grid-column:1;grid-row:4}
    .left-top,.right-top,.left-bottom{grid-column:1}
    #clock-time{font-size:36px}
  }
</style>
</head>
<body>
  <div class="board" id="board">

    <!-- TOP BAR -->
    <div class="topbar">
      <div class="title">
        <div class="logo">Š</div>
        <div>
          <div class="school-name">ZŠ Březové Hory</div>
          <div class="meta" id="meta-status">Aktualizováno: —</div>
        </div>
      </div>
      <div class="meta">Napájení: online • Režim: veřejná tabule</div>
    </div>

    <!-- LEFT TOP: Clock + Progress -->
    <div class="left-top">
      <div class="card clock-large">
        <div class="card-header"><div class="icon"><i class="fa-regular fa-clock"></i></div><h3>Čas & Datum</h3></div>
        <div id="clock-time">--:--:--</div>
        <div id="clock-date">—</div>
        <div id="current-holiday" class="meta-small">Svátek: —</div>

        <div style="margin-top:6px" class="card-header"><div class="icon"><i class="fa-solid fa-hourglass-half"></i></div><h3>Hodina / přestávka</h3></div>
        <div class="progress-row">
          <div class="time-left" id="time-left">--</div>
          <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
          <div class="time-end" id="time-end">--:--</div>
        </div>
        <div class="block-info" id="current-block-info">—</div>
      </div>
    </div>

    <!-- CENTER TOP: Weather + Lunch -->
    <div class="center-top">
      <div class="card">
        <div class="card-header"><div class="icon"><i class="fa-solid fa-cloud-sun"></i></div><h3>Počasí (Příbram)</h3></div>
        <div id="weather-now" class="weather-day"><div class="weather-icon">—</div><div class="weather-main">Načítám počasí...</div></div>
        <div id="weather-day1" class="weather-day">Načítám zítra...</div>
        <div id="weather-day2" class="weather-day">Načítám pozítří...</div>
      </div>

      <div class="card" style="min-height:150px">
        <div class="card-header"><div class="icon"><i class="fa-solid fa-utensils"></i></div><h3>Dnešní oběd</h3></div>
        <div id="obed" class="meta-small">Načítám jídelníček...</div>
      </div>
    </div>

    <!-- RIGHT TOP: News + Departures -->
    <div class="right-top">
      <div class="card" style="min-height:220px">
        <div class="card-header"><div class="icon"><i class="fa-solid fa-newspaper"></i></div><h3>Aktuality</h3></div>
        <div id="news">
          <div class="news-item"><div style="width:110px;height:70px;background:#072a2d;border-radius:8px"></div><div><b>Středoškolský atletický pohár</b><div class="meta-small">Školní družstvo — skvělé výsledky.</div></div></div>
          <div class="news-item"><div style="width:110px;height:70px;background:#072a2d;border-radius:8px"></div><div><b>Nové lavice v 7.A</b><div class="meta-small">Instalace proběhla o víkendu.</div></div></div>
        </div>
      </div>

      <div class="card" style="min-height:320px">
        <div class="card-header"><div class="icon"><i class="fa-solid fa-bus"></i></div><h3>Odjezdy PID</h3></div>
        <div id="departures" class="departures">
          <div class="small-meta">Načítám odjezdy...</div>
        </div>
        <div class="meta-small" id="pid-note">—</div>
      </div>
    </div>

    <!-- LEFT BOTTOM: quick info -->
    <div class="left-bottom">
      <div class="card">
        <div class="card-header"><div class="icon"><i class="fa-solid fa-info-circle"></i></div><h3>Rychlé info</h3></div>
        <div class="meta-small">Přihlášky na lyžařský výcvik do 30.11. • Kroužek robotiky od 1.11.</div>
      </div>

      <div class="card">
        <div class="card-header"><div class="icon"><i class="fa-solid fa-list"></i></div><h3>Rozvrh (rychle)</h3></div>
        <div class="meta-small">Nultá 07:00–07:45 • Přestávka 07:45–08:00 • 1. 08:00–08:45 • 2. 08:55–09:40 • Velká přest. 09:40–10:00 • ...</div>
      </div>
    </div>

    <!-- CENTER BOTTOM: bigger area for additional info -->
    <div class="center-bottom">
      <div class="card" style="min-height:200px">
        <div class="card-header"><div class="icon"><i class="fa-solid fa-calendar-days"></i></div><h3>Kalendář & události</h3></div>
        <div class="meta-small">03.11. Exkurze do Planetária • 11.11. Den otevřených dveří • 20.12. Vánoční koncert</div>
      </div>
    </div>

    <!-- ticker across bottom (posouvá text zleva doprava) -->
    <div class="ticker">
      <div class="marquee" id="marq">ZŠ Březové Hory — aktuální informace • Sledujte web školy • Přihlášky na lyžařský výcvik do 30.11. • Kontakt: sekretariat@zsbrezovehory.cz</div>
    </div>

    <div class="live-clock-badge" id="live-badge">--:--</div>
  </div>

<script>
/* ===================== CONFIG ===================== */
const REFRESH_MIN = 10; // minutes
const LUNCH_URL = 'https://zsbrezovehory.cz/jidelni-listek/';
const LUNCH_PROXY = 'https://api.allorigins.win/raw?url=';

// PID API (user-provided token)
const PID_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NDA2NSwiaWF0IjoxNzYxMjg1NTE1LCJleHAiOjExNzYxMjg1NTE1LCJpc3MiOiJnb2xlbWlvIiwianRpIjoiYzNmYWY5MGMtMGEyMi00OWE1LWI1MDktM2NiM2YwN2NiOGU0In0.ugD7g2PQ_aLZX3Hhke3rnbxFWcmn_d_5_4BXcRH9qpw';
const PID_BASE = 'https://api.golemio.cz/pid/input-gateway/v1';

// PID stops (stopAreaIds you gave / discovered)
const pidStops = [
  { stopAreaId: '52838', name: 'Příbram, Březové Hory, Mariánská' }, // you gave 52838
  { stopAreaId: '9739/1', name: 'Příbram, Březové Hory, náměstí (platforma A)' },
  { stopAreaId: '1409175511863_MAI00278', name: 'Příbram, Březové Hory, domov seniorů' }
];

/* ===================== HELPERS ===================== */
function pad2(n){ return String(n).padStart(2,'0'); }
function setMeta(t){ document.getElementById('meta-status').textContent = 'Aktualizováno: ' + t; }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* SCHEDULE DEFINITION */
const schedule = [
  {start:'07:00',end:'07:45',label:'Nultá hodina',type:'lesson'},
  {start:'07:45',end:'08:00',label:'Přestávka',type:'break'},
  {start:'08:00',end:'08:45',label:'1. hodina',type:'lesson'},
  {start:'08:45',end:'08:55',label:'Přestávka',type:'break'},
  {start:'08:55',end:'09:40',label:'2. hodina',type:'lesson'},
  {start:'09:40',end:'10:00',label:'Velká přestávka',type:'break'},
  {start:'10:00',end:'10:45',label:'3. hodina',type:'lesson'},
  {start:'10:45',end:'10:55',label:'Přestávka',type:'break'},
  {start:'10:55',end:'11:40',label:'4. hodina',type:'lesson'},
  {start:'11:40',end:'11:50',label:'Přestávka',type:'break'},
  {start:'11:50',end:'12:35',label:'5. hodina',type:'lesson'},
  {start:'12:35',end:'12:45',label:'Přestávka',type:'break'},
  {start:'12:45',end:'13:30',label:'6. hodina',type:'lesson'},
  {start:'13:30',end:'13:40',label:'Přestávka',type:'break'},
  {start:'13:40',end:'14:25',label:'7. hodina',type:'lesson'},
  {start:'14:25',end:'14:35',label:'Přestávka',type:'break'},
  {start:'14:35',end:'15:20',label:'8. hodina',type:'lesson'},
  {start:'15:20',end:'15:30',label:'Přestávka',type:'break'},
  {start:'15:30',end:'16:15',label:'9. hodina',type:'lesson'}
];

function toTodayDate(hm){
  const [h,m] = hm.split(':').map(Number);
  const d = new Date();
  return new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0, 0);
}
function currentBlock(now=new Date()){
  for(const b of schedule){
    const s = toTodayDate(b.start);
    const e = toTodayDate(b.end);
    if(now >= s && now < e) return {block:b, start:s, end:e};
  }
  return null;
}

/* ===================== CLOCK + HOLIDAY + PROGRESS ===================== */
function updateClock(){
  const now = new Date();
  document.getElementById('clock-time').textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
  document.getElementById('clock-date').textContent = now.toLocaleDateString('cs-CZ',{weekday:'long', day:'numeric', month:'long', year:'numeric'});
  document.getElementById('live-badge').textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
  setMeta(`${pad2(now.getHours())}:${pad2(now.getMinutes())}`);

  // holiday (nameday) via Abalin API
  fetch(`https://api.abalin.net/v1/namedays?country=cz&day=${now.getDate()}&month=${now.getMonth()+1}`)
    .then(r=>r.json()).then(j=>{
      try{
        if(j && j.data && j.data.nameday && j.data.nameday.cz){
          document.getElementById('current-holiday').textContent = 'Svátek: ' + j.data.nameday.cz;
        } else {
          document.getElementById('current-holiday').textContent = 'Svátek: –';
        }
      }catch(e){ document.getElementById('current-holiday').textContent = 'Svátek: –'; }
    }).catch(()=>{ document.getElementById('current-holiday').textContent = 'Svátek: –'; });

  // progress bar for current lesson/break
  const cur = currentBlock(now);
  const fill = document.getElementById('progress-fill');
  const left = document.getElementById('time-left');
  const end = document.getElementById('time-end');
  const info = document.getElementById('current-block-info');
  if(cur){
    const total = cur.end - cur.start;
    const done = now - cur.start;
    const pct = Math.max(0,Math.min(100, Math.round(done/total*100)));
    fill.style.width = pct + '%';
    // color: green => red depending on pct (HSL)
    const hue = Math.max(0, 120 - Math.round(pct * 1.2));
    fill.style.background = `linear-gradient(90deg, hsl(${hue},70%,50%), ${getComputedStyle(document.documentElement).getPropertyValue('--accent-2')})`;
    const minsLeft = Math.max(0, Math.ceil((cur.end - now)/60000));
    const hh = Math.floor(minsLeft/60);
    const mm = minsLeft % 60;
    left.textContent = (hh>0?hh+'h ':'') + mm + 'm';
    end.textContent = `${pad2(cur.end.getHours())}:${pad2(cur.end.getMinutes())}`;
    info.textContent = `${cur.block.label} • ${cur.block.type === 'lesson' ? 'výuka' : 'přestávka'}`;
  } else {
    fill.style.width = '0%';
    left.textContent = '--';
    end.textContent = '--:--';
    info.textContent = 'Mimo vyučování';
  }
}

/* ===================== WEATHER (Open-Meteo) ===================== */
async function fetchWeather(){
  const lat = 49.6895, lon = 14.0106; // approx Příbram
  try{
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=Europe%2FPrague`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    if(j && j.current_weather){
      const cur = j.current_weather;
      const wtxt = mapWeather(cur.weathercode);
      document.getElementById('weather-now').innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div class="weather-icon">${iconForCode(cur.weathercode)}</div><div><div class="weather-main">${cur.temperature} °C — ${wtxt}</div><div class="weather-sub">Vítr ${cur.windspeed} km/h • ${cur.winddirection}°</div></div></div>`;
      const d = j.daily;
      if(d){
        document.getElementById('weather-day1').innerHTML = `<div><div class="weather-main">Zítra: ${d.temperature_2m_max[1]} °C / ${d.temperature_2m_min[1]} °C</div><div class="weather-sub">${mapWeather(d.weathercode[1])}</div></div>`;
        document.getElementById('weather-day2').innerHTML = `<div><div class="weather-main">Pozítří: ${d.temperature_2m_max[2]} °C / ${d.temperature_2m_min[2]} °C</div><div class="weather-sub">${mapWeather(d.weathercode[2])}</div></div>`;
      }
    } else {
      document.getElementById('weather-now').textContent = 'Počasí: nedostupné';
    }
  }catch(e){
    console.warn('Weather error', e);
    document.getElementById('weather-now').textContent = 'Chyba při načítání počasí';
    document.getElementById('weather-day1').textContent = '—';
    document.getElementById('weather-day2').textContent = '—';
  }
}
function mapWeather(code){
  const map = {0:'Jasno',1:'Polojasno',2:'Oblačno',3:'Zataženo',45:'Mlha',48:'Mrznoucí mlha',51:'Slabé mrholení',61:'Déšť',71:'Sníh',95:'Bouřka'};
  return map[code] || 'Neurčeno';
}
function iconForCode(code){
  // simple emoji icons for clarity; could map to svg later
  if(code === 0) return '☀️';
  if(code === 1 || code === 2) return '⛅';
  if(code === 3) return '☁️';
  if(code === 45 || code === 48) return '🌫️';
  if(code >= 51 && code < 70) return '🌦️';
  if(code >= 61 && code < 69) return '🌧️';
  if(code >= 71 && code < 80) return '❄️';
  if(code >= 95) return '⛈️';
  return '🌈';
}

/* ===================== LUNCH (scrape via proxy) ===================== */
async function fetchLunch(){
  const out = document.getElementById('obed');
  out.innerHTML = 'Načítám jídelníček...';
  try{
    const r = await fetch(LUNCH_PROXY + encodeURIComponent(LUNCH_URL), {cache:'no-store'});
    if(!r.ok) throw new Error('proxy fail '+r.status);
    const html = await r.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html,'text/html');

    const selectors = ['.entry-content','.post-content','.elementor-widget-container','main','article','.content','.wp-block-group'];
    let node = null;
    for(const sel of selectors){
      const el = doc.querySelector(sel);
      if(el && el.textContent.trim().length > 40){ node = el; break; }
    }
    if(!node){
      // fallback: show trimmed body text
      const txt = doc.body.textContent.trim().slice(0,2000);
      out.innerHTML = '<div class="meal">'+escapeHtml(txt)+'</div>';
      return;
    }

    // prefer lists, otherwise paragraphs
    const ul = node.querySelector('ul, ol');
    if(ul){
      const items = Array.from(ul.querySelectorAll('li')).slice(0,30);
      out.innerHTML = '';
      items.forEach(li=>{
        const d = document.createElement('div');
        d.className = 'meal';
        d.textContent = li.textContent.trim();
        out.appendChild(d);
      });
      return;
    }
    const ps = node.querySelectorAll('p');
    if(ps && ps.length){
      out.innerHTML = '';
      Array.from(ps).slice(0,8).forEach(p=>{
        const d = document.createElement('div'); d.className='meal'; d.textContent = p.textContent.trim(); out.appendChild(d);
      });
      return;
    }

    out.innerHTML = '<div class="meal">' + escapeHtml(node.textContent.trim().slice(0,2000)) + '…</div>';
  }catch(e){
    console.warn('Lunch error', e);
    out.innerHTML = '<em>Nelze načíst jídelníček (proxy/CORS).</em>';
  }
}

/* ===================== PID departures (Golemio) ===================== */
async function fetchDepartures(){
  const container = document.getElementById('departures');
  const note = document.getElementById('pid-note');
  container.innerHTML = '';
  note.textContent = 'Načítám odjezdy... (pokus o přímé volání API)';
  let anyError = false;

  for(const s of pidStops){
    const block = document.createElement('div'); block.className = 'stop-block';
    const title = document.createElement('div'); title.className = 'stop-name'; title.textContent = s.name;
    const listWrap = document.createElement('div'); listWrap.textContent = 'Načítám...';
    block.appendChild(title); block.appendChild(listWrap); container.appendChild(block);

    try{
      const url = `${PID_BASE}/departures?stopAreaId=${encodeURIComponent(s.stopAreaId)}&maxNo=8`;
      const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + PID_TOKEN } });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const j = await res.json();

      // normalize shape
      let deps = null;
      if(Array.isArray(j)) deps = j;
      else if(j.departures) deps = j.departures;
      else if(j.data && Array.isArray(j.data)) deps = j.data;
      else deps = j.departures || j.data || null;

      if(!deps || deps.length === 0){
        listWrap.textContent = 'Žádné odjezdy (nebo prázdná odpověď)';
        continue;
      }
      listWrap.innerHTML = '';
      deps.slice(0,8).forEach(d=>{
        const line = (d.line && (d.line.name || d.line)) || d.routeShortName || d.routeId || d.lineRef || '—';
        const direction = d.direction || d.destination || d.headsign || '';
        let timeText = '—';
        if(d.timePlanned) timeText = extractTime(d.timePlanned);
        else if(d.timePlannedRelative) timeText = d.timePlannedRelative;
        else if(d.time) timeText = extractTime(d.time);
        else if(d.expectedArrival) timeText = extractTime(d.expectedArrival);
        let delay = null;
        if(d.delay !== undefined) delay = d.delay;
        else if(d.expectedDelay !== undefined) delay = d.expectedDelay;
        else if(d.realtime && d.realtime.expectedDelay) delay = d.realtime.expectedDelay;

        const li = document.createElement('div'); li.className='dep-row';
        const left = document.createElement('div'); left.className='dep-left'; left.textContent = `${line} → ${direction}`;
        const right = document.createElement('div'); right.className='dep-time';
        right.textContent = `${timeText}` + (delay && Number(delay) !== 0 ? ` (+${delay} min)` : '');
        li.appendChild(left); li.appendChild(right); listWrap.appendChild(li);
      });

    }catch(err){
      console.warn('PID error for', s.stopAreaId, err);
      anyError = true;
      listWrap.innerHTML = `<div style="color:#f6c6a8"><b>Chyba při načítání (API/CORS)</b><div class="small-meta">Pokud vidíš tuto chybu, prohlížeč blokuje přímé volání na Golemio (CORS). Řešení: použít server-proxy (Cloudflare Worker). Níže je připravený worker kód — zkopíruj a nasad do Cloudflare, vlož tam svůj TOKEN a worker umožní volání z prohlížeče.</div></div>`;
    }
  } // for stops

  if(anyError){
    note.innerHTML = 'Poznámka: API nebo CORS blokují přímé požadavky. <b>Řešení:</b> nasadit server-proxy (Cloudflare Worker). Níže najdeš hotový Worker.';
    const workerSnippet = `
/* Cloudflare Worker: přepošle požadavky na Golemio PID s tokenem a povolí CORS */
addEventListener('fetch', event => {
  event.respondWith(handle(event.request));
});
const TOKEN = 'REPLACE_WITH_PID_TOKEN';
const TARGET = 'https://api.golemio.cz/pid/input-gateway/v1';
async function handle(req){
  const url = new URL(req.url);
  // expects path param 'path' containing target path, e.g. /departures?stopAreaId=52838&maxNo=8
  const path = url.searchParams.get('path') || '/departures';
  const forwardUrl = TARGET + path + (url.search ? '&' + url.searchParams.toString() : '');
  // direct forward (be careful with query duplication) - alternatively implement explicit mapping
  const r = await fetch(forwardUrl, { headers: { 'Authorization': 'Bearer ' + TOKEN }});
  const txt = await r.text();
  const headers = new Headers(r.headers);
  headers.set('Access-Control-Allow-Origin','*');
  headers.set('Access-Control-Allow-Methods','GET,OPTIONS');
  headers.set('Access-Control-Allow-Headers','Authorization,Content-Type');
  return new Response(txt, { status: r.status, headers });
}
    `;
    note.insertAdjacentHTML('beforeend', `<pre style="white-space:pre-wrap;margin-top:8px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;color:#ffd9b8;font-size:12px">${escapeHtml(workerSnippet)}</pre>`);
  } else {
    note.textContent = 'Odjezdy načteny.';
  }
}

function extractTime(value){
  if(!value) return '—';
  if(typeof value === 'string'){
    const m = value.match(/\d{2}:\d{2}/);
    if(m) return m[0];
    const nu = Date.parse(value);
    if(!isNaN(nu)){ const d = new Date(nu); return pad2(d.getHours())+':'+pad2(d.getMinutes()); }
    return value;
  } else if(typeof value === 'number'){
    const d = value>1e12 ? new Date(value) : new Date(value*1000);
    return pad2(d.getHours())+':'+pad2(d.getMinutes());
  } else return String(value);
}

/* ===================== TICKER (ensure long) ===================== */
function initTicker(){
  const m = document.getElementById('marq');
  if(m.textContent.length < 120){
    m.textContent = m.textContent + ' • ' + m.textContent + ' • ' + m.textContent;
  }
}

/* ===================== INIT / INTERVALS ===================== */
function refreshAll(){
  updateClock();
  fetchWeather();
  fetchLunch();
  fetchDepartures();
  initTicker();
}
refreshAll();
setInterval(updateClock, 1000); // every second for clock
setInterval(fetchWeather, REFRESH_MIN * 60 * 1000);
setInterval(fetchLunch, REFRESH_MIN * 60 * 1000);
setInterval(fetchDepartures, REFRESH_MIN * 60 * 1000); // 10 minutes for PID too
// also keep trying departures a bit more often so updates appear quicker
setInterval(fetchDepartures, 60 * 1000);

</script>
</body>
</html>

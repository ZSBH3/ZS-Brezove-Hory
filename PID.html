<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Informační tabule — ZŠ Březové Hory</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
/* ================== THEME (zachováno) ================== */
:root{
  --bg1:#08272d; --bg2:#0e3b46; --accent:#ff8a3d;
  --glass:rgba(255,255,255,0.04); --card:#0b2530; --muted:#9fb0bd;
  --radius:18px; --gap:18px; --border:1px solid rgba(255,255,255,0.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#eaf2f5;font-family:'Poppins',sans-serif}
body{display:flex;align-items:center;justify-content:center;padding:18px}

/* ================== CANVAS ================== */
.canvas{
  width:100%; height:100%; max-width:2200px; max-height:1350px;
  display:grid;
  grid-template-rows: auto 1fr auto;
  gap:var(--gap);
}

/* ================== TOP BAR ================== */
.topbar{
  display:flex; align-items:center; justify-content:space-between; gap:16px;
  padding:16px 22px; border-radius:26px;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  box-shadow:0 20px 60px rgba(1,8,12,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
  border:var(--border);
}
.title{display:flex;align-items:center;gap:14px}
.logo{
  width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,#00b3a6,#045a63);
  display:flex;align-items:center;justify-content:center;font-weight:700;font-size:26px;color:white;
  box-shadow:0 6px 18px rgba(0,0,0,0.5);
}
.school-name{font-size:28px;font-weight:700;letter-spacing:0.6px;color:#ffefdc;text-shadow:0 3px 20px rgba(0,0,0,0.4)}
.meta{color:var(--muted);font-size:13px}

/* ================== GRID ================== */
.grid{
  display:grid; gap:var(--gap);
  grid-template-columns: 1.2fr 1fr 1fr;
  grid-template-rows: 1fr 1fr;
  min-height:0;
}

/* ================== CARD ================== */
.card{
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius: var(--radius);
  padding:18px;
  box-shadow: 0 10px 40px rgba(1,8,12,0.5);
  border:var(--border);
  display:flex; flex-direction:column; gap:12px; min-height:140px; overflow:hidden;
}
.card-header{display:flex;align-items:center;gap:12px}
.card-header .icon{font-size:26px;color:var(--accent);text-shadow:0 0 14px rgba(255,138,61,0.15)}
.card-header h3{margin:0;font-size:18px;color:#ffdcbc}

/* ================== CLOCK + LESSON ================== */
.clockWrap{display:grid;grid-template-columns:1fr;gap:12px}
.clock-main{display:flex;align-items:center;gap:18px;flex-wrap:wrap}
#clock-time{font-size:48px;font-weight:700;letter-spacing:1px;text-shadow:0 6px 18px rgba(0,0,0,0.45)}
#clock-date{color:#d7e6ee;font-size:16px}
.badge{background:var(--accent);color:#081018;padding:6px 10px;border-radius:10px;font-weight:700;box-shadow:0 8px 30px rgba(0,0,0,0.6)}

.lessonBox{display:grid;grid-template-columns: 1.1fr auto;gap:12px;align-items:center}
.lessonText{display:flex;flex-direction:column;gap:6px}
.lessonTitle{font-size:18px;font-weight:700}
.lessonSub{font-size:14px;color:var(--muted)}
.progressRow{display:flex;align-items:center;gap:12px}
.progressShell{flex:1;height:14px;border-radius:999px;background:rgba(255,255,255,0.06);position:relative;overflow:hidden}
.progressBar{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#ff8a3d,#ffc08a);border-radius:999px;transition:width .3s ease}
.progressInfo{display:flex;gap:16px;font-family:'Roboto Condensed',sans-serif}
.progressInfo div{font-size:14px;color:#ffdcbc}

/* ================== WEATHER ================== */
.weatherGrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;align-items:stretch}
.wCard{background:rgba(255,255,255,0.03);border:var(--border);border-radius:12px;padding:12px;display:flex;gap:12px;align-items:center}
.wIcon{font-size:30px}
.wMain{display:flex;flex-direction:column;gap:4px}
.wTemp{font-size:18px;font-weight:700}
.wSub{font-size:13px;color:var(--muted)}
#small-weather{display:flex;gap:12px;align-items:center}
#small-weather .w-icon{font-size:26px}
#small-weather .w-main{font-size:16px;font-weight:600}

/* ================== DEPARTURES ================== */
.departures{display:flex;flex-direction:column;gap:10px;min-height:0;overflow:auto}
.stopBlock{background:rgba(255,255,255,0.04);border:var(--border);border-radius:12px;padding:10px}
.stopHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:10px;flex-wrap:wrap}
.stopName{display:flex;align-items:center;gap:8px;font-weight:700;color:#ffdcbc}
.depRow{display:grid;grid-template-columns: 72px 1fr auto auto;gap:8px;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);font-size:14px;align-items:center}
.depRow .line{font-weight:800;letter-spacing:0.3px}
.depRow .dir{color:#eaf2f5}
.depRow .time{font-weight:700;color:#ffd9b8}
.depRow .delay{font-weight:700}
.delay.plus{color:#ffb3b3}
.delay.zero{color:#9fe29f}
.delay.na{color:#d3d3d3}

/* ================== MENU ================== */
#obed{font-size:1rem;line-height:1.6;overflow:auto;padding-right:6px}
#obed h4{margin:0 0 8px 0;color:#ffd9b8}
.meal{padding:8px 10px;border-radius:10px;margin-bottom:8px;background:linear-gradient(90deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}

/* ================== NEWS + EVENTS ================== */
.newsWrap{display:flex;gap:12px}
.newsThumb{width:160px;height:110px;border-radius:10px;background:#072a2d;background-size:cover;background-position:center;flex-shrink:0}
.newsTxt{flex:1;text-align:left;font-size:14px;color:#e6eef4}
.eventsList{display:flex;flex-direction:column;gap:8px;font-size:15px}
.eventItem{padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);border:var(--border)}

/* ================== BOTTOM TICKER ================== */
.tickerWrap{
  position:relative; height:56px; border-radius:14px; border:var(--border);
  background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
  display:grid; grid-template-columns: 180px 1fr; align-items:center; overflow:hidden; padding:0 0 0 10px;
}
.tickerTime{display:flex;align-items:center;gap:8px;font-weight:800}
.tickerTrack{position:relative; height:100%; overflow:hidden}
.tickerLane{white-space:nowrap; position:absolute; will-change:transform; font-size:16px; line-height:56px}
.tickerLane span{margin-right:36px}

/* ================== RESPONSIVE ================== */
@media (max-width: 1360px){
  .grid{grid-template-columns: 1fr 1fr; grid-template-rows: auto auto auto}
}
@media (max-width: 900px){
  .grid{grid-template-columns: 1fr; grid-template-rows: auto auto auto auto auto auto}
  #clock-time{font-size:38px}
}

/* utility hidden */
.hidden{display:none!important}
</style>
</head>
<body>
<div class="canvas">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="title">
      <div class="logo">Š</div>
      <div>
        <div class="school-name">ZŠ Březové Hory — Informační tabule</div>
        <div class="meta" id="meta-status">Aktualizováno: —</div>
      </div>
    </div>
    <div class="meta">Napájení: online • Režim: veřejná tabule</div>
  </div>

  <!-- MAIN GRID -->
  <div class="grid" id="grid">

    <!-- CLOCK + LESSON -->
    <div class="card" id="card-clock">
      <div class="card-header">
        <div class="icon"><i class="fa-regular fa-clock"></i></div>
        <div><h3>Čas & Hodina</h3><div class="meta">Přesnost: systémová</div></div>
      </div>

      <div class="clockWrap">
        <div class="clock-main">
          <div>
            <div id="clock-time">--:--:--</div>
            <div id="clock-date">—</div>
          </div>
          <div id="small-weather" class="badge" title="Rychlý přehled počasí">
            <span class="w-icon">⛅</span><span class="w-main">Načítám...</span>
          </div>
          <div id="nameday" class="badge">Svátek: —</div>
        </div>

        <div class="lessonBox">
          <div class="lessonText">
            <div class="lessonTitle" id="lesson-title">—</div>
            <div class="lessonSub" id="lesson-sub">—</div>
            <div class="progressRow">
              <div class="progressShell"><div class="progressBar" id="progress-bar"></div></div>
              <div class="progressInfo">
                <div id="progress-left">Zbývá: —</div>
                <div id="progress-end">Konec: —</div>
              </div>
            </div>
          </div>
          <div class="badge" id="lesson-state">—</div>
        </div>
      </div>
    </div>

    <!-- WEATHER -->
    <div class="card" id="card-weather">
      <div class="card-header">
        <div class="icon"><i class="fa-solid fa-cloud-sun"></i></div>
        <div><h3>Počasí</h3><div class="meta">Aktuální + 2 dny</div></div>
      </div>
      <div class="weatherGrid">
        <div class="wCard">
          <div class="wIcon" id="w0-icon">⛅</div>
          <div class="wMain">
            <div class="wTemp" id="w0-temp">—</div>
            <div class="wSub" id="w0-sub">—</div>
          </div>
        </div>
        <div class="wCard">
          <div class="wIcon" id="w1-icon">⛅</div>
          <div class="wMain">
            <div class="wTemp" id="w1-temp">—</div>
            <div class="wSub" id="w1-sub">Zítra</div>
          </div>
        </div>
        <div class="wCard">
          <div class="wIcon" id="w2-icon">⛅</div>
          <div class="wMain">
            <div class="wTemp" id="w2-temp">—</div>
            <div class="wSub" id="w2-sub">Pozítří</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DEPARTURES -->
    <div class="card" id="card-deps">
      <div class="card-header">
        <div class="icon"><i class="fa-solid fa-bus"></i></div>
        <div><h3>Odjezdy PID</h3><div class="meta">Autobusy — Mariánská, Náměstí</div></div>
      </div>
      <div class="departures" id="departures">
        <div class="meta">Načítám odjezdy...</div>
      </div>
    </div>

    <!-- MENU -->
    <div class="card" id="card-menu">
      <div class="card-header">
        <div class="icon"><i class="fa-solid fa-utensils"></i></div>
        <div><h3>Dnešní oběd</h3><div class="meta">Zdroj: zsbrezovehory.cz</div></div>
      </div>
      <div id="obed"><em>Načítám jídelníček...</em></div>
    </div>

    <!-- EVENTS -->
    <div class="card" id="card-events">
      <div class="card-header">
        <div class="icon"><i class="fa-regular fa-calendar-days"></i></div>
        <div><h3>Kalendář akcí</h3><div class="meta">Nejbližší události</div></div>
      </div>
      <div class="eventsList" id="events">
        <div class="eventItem">03. 11. — Exkurze do Planetária</div>
        <div class="eventItem">11. 11. — Den otevřených dveří</div>
        <div class="eventItem">20. 12. — Vánoční koncert</div>
      </div>
    </div>

    <!-- NEWS -->
    <div class="card" id="card-news">
      <div class="card-header">
        <div class="icon"><i class="fa-solid fa-newspaper"></i></div>
        <div><h3>Aktuality</h3><div class="meta">Novinky ze školy</div></div>
      </div>
      <div class="newsWrap">
        <div class="newsThumb" id="news-thumb" style="background-image:url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?q=80&w=800&auto=format&fit=crop');"></div>
        <div class="newsTxt">
          <h4 style="margin:0 0 6px 0;color:#ffdcbc">Středoškolský atletický pohár ve znamení gymnazistů</h4>
          <p style="margin:0">Školní družstvo dosáhlo skvělých výsledků. Podrobnosti najdete na webu školy.</p>
          <ul style="margin:10px 0 0 18px;line-height:1.6">
            <li>Nové lavice v 7.A a 7.B</li>
            <li>Od 1. 11. začíná kroužek robotiky</li>
            <li>Přihlášky na lyžařský výcvik do 30. 11.</li>
          </ul>
        </div>
      </div>
    </div>

  </div>

  <!-- BOTTOM TICKER -->
  <div class="tickerWrap">
    <div class="tickerTime"><i class="fa-regular fa-clock"></i><span id="ticker-time">--:--</span></div>
    <div class="tickerTrack">
      <div class="tickerLane" id="ticker-lane">
        <span>Ve čtvrtek 29. října se bude od 9:40 ve velké tělocvičně konat tradiční předávání anglických certifikátů.</span>
        <span>Jídelna: vydávání obědů 11:30–14:00.</span>
        <span>Prosíme, kontrolujte eŽK – nové známky a domácí úkoly.</span>
      </div>
    </div>
  </div>

</div>

<script>
/* ================== KONFIG ================== */
const REFRESH_MIN = 10; // celkový refresh (počasí, jídelníček, odjezdy, svátek)
const SCHOOL_MENU_URL = "https://zsbrezovehory.cz/jidelni-listek/";
const PROXY_RAW = "https://api.allorigins.win/raw?url="; // pro jídelníček a fallbacky

/* PID Golemio v2 (CORS vyžaduje povolenou doménu v Golemio) */
const PID_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NDA2NSwiaWF0IjoxNzYxMjg1NTE1LCJleHAiOjExNzYxMjg1NTE1LCJpc3MiOiJnb2xlbWlvIiwianRpIjoiYzNmYWY5MGMtMGEyMi00OWE1LWI1MDktM2NiM2YwN2NiOGU0In0.ugD7g2PQ_aLZX3Hhke3rnbxFWcmn_d_5_4BXcRH9qpw";
const PID_BASE = "https://api.golemio.cz/v2/departureboards";
/* Ověřené GTFS stop IDs */
const STOPS = [
  { id: "U9740Z1", name: "Příbram, Březové Hory, Mariánská (A)" },
  { id: "U9739Z1", name: "Příbram, Březové Hory, náměstí (A)" },
];

/* ================== UTIL ================== */
const $ = sel => document.querySelector(sel);
function setMetaStatus(){ $('#meta-status').textContent = 'Aktualizováno: ' + new Date().toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) }
function pad2(n){return n<10?'0'+n:n}
function fmtTime(d){return pad2(d.getHours())+':'+pad2(d.getMinutes())}
function secondsToMinSec(s){ const m=Math.floor(s/60), sec=s%60; return `${m} min ${pad2(sec)} s` }

function textWeatherIcon(code){
  if(code===0) return "☀️";
  if(code===1||code===2) return "⛅";
  if(code===3) return "☁️";
  if(code===45||code===48) return "🌫️";
  if(code>=51&&code<=67) return "🌧️";
  if(code>=71&&code<=77) return "❄️";
  if(code>=80&&code<=82) return "🌦️";
  if(code===95||code===96||code===99) return "⛈️";
  return "⛅";
}
function weatherText(code){
  const map={0:'Jasno',1:'Polojasno',2:'Oblačno',3:'Zataženo',45:'Mlha',48:'Mrznoucí mlha',51:'Slabé mrholení',53:'Mrholení',55:'Silné mrholení',61:'Slabý déšť',63:'Déšť',65:'Silný déšť',71:'Sníh',73:'Sněžení',75:'Silné sněžení',80:'Přeháňky',81:'Přeháňky',82:'Silné přeháňky',95:'Bouřka',96:'Bouřka s kroupami',99:'Silná bouřka s kroupami'};
  return map[code]||'Počasí';
}

/* ================== HODINY + LEKCE ================== */
/* nultá 7:00–7:45, 15' pauza, 1. hod 8:00–8:45, 10' pauza, 2. hod 8:55–9:40, 20' velká, 3.–9. po 45' + 10' */
const DAY_PLAN = (()=> {
  const items = [];
  const add=(title,h,m,dur,isBreak)=>{const s=h*60+m;const e=s+dur;items.push({title,isBreak,start:{h,m},end:{h:Math.floor(e/60),m:e%60},sMin:s,eMin:e,durMin:dur});};
  add("0. hodina",7,0,45,false); add("Přestávka",7,45,15,true);
  add("1. hodina",8,0,45,false); add("Přestávka",8,45,10,true);
  add("2. hodina",8,55,45,false); add("Velká přestávka",9,40,20,true);
  add("3. hodina",10,0,45,false); add("Přestávka",10,45,10,true);
  add("4. hodina",10,55,45,false); add("Přestávka",11,40,10,true);
  add("5. hodina",11,50,45,false); add("Přestávka",12,35,10,true);
  add("6. hodina",12,45,45,false); add("Přestávka",13,30,10,true);
  add("7. hodina",13,40,45,false); add("Přestávka",14,25,10,true);
  add("8. hodina",14,35,45,false); add("Přestávka",15,20,10,true);
  add("9. hodina",15,30,45,false);
  return items;
})();

function updateClock(){
  const d=new Date();
  $('#clock-time').textContent=d.toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  $('#clock-date').textContent=d.toLocaleDateString('cs-CZ',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  $('#ticker-time').textContent=d.toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'});
}
setInterval(updateClock,1000); updateClock();

function updateLesson(){
  const now = new Date();
  const nowMin = now.getHours()*60 + now.getMinutes();
  let current = null;
  for(const b of DAY_PLAN){ if(nowMin>=b.sMin && nowMin<b.eMin){ current=b; break; } }
  let title, sub, left, endt, pct, state;
  if(current){
    title = current.title;
    sub = (current.isBreak?'Přestávka':'Výuka') + ` • ${pad2(current.start.h)}:${pad2(current.start.m)} – ${pad2(current.end.h)}:${pad2(current.end.m)}`;
    const elapsed = (nowMin*60 + now.getSeconds()) - (current.sMin*60);
    const total = (current.eMin - current.sMin)*60;
    const remain = Math.max(0,total - elapsed);
    pct = Math.min(100, Math.max(0, (elapsed/total)*100 ));
    left = `Zbývá: ${secondsToMinSec(Math.floor(remain))}`;
    endt = `Konec: ${pad2(current.end.h)}:${pad2(current.end.m)}`;
    state = current.isBreak ? 'PŘESTÁVKA' : 'HODINA';
  } else {
    title = "Mimo vyučování";
    sub = "—";
    left = "Zbývá: —";
    endt = "Konec: —";
    pct = 0; state = "VOLNO";
  }
  $('#lesson-title').textContent = title;
  $('#lesson-sub').textContent = sub;
  $('#progress-left').textContent = left;
  $('#progress-end').textContent = endt;
  $('#progress-bar').style.width = pct.toFixed(1)+'%';
  $('#lesson-state').textContent = state;
}
setInterval(updateLesson,1000); updateLesson();

/* ================== SVÁTEK (jmeniny přes API s cache) + státní svátky offline ================== */
function easterDate(year){ // Computus (Meeus/Jones/Butcher)
  const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;return new Date(year,month-1,day);}
function isCzechPublicHoliday(date){
  const y=date.getFullYear(), m=date.getMonth()+1, d=date.getDate();
  const fixed = ["01-01","05-01","05-08","07-05","07-06","09-28","10-28","11-17","12-24","12-25","12-26"];
  const md = pad2(m)+"-"+pad2(d);
  if(fixed.includes(md)) return true;
  const easter = easterDate(y);
  const gf = new Date(easter); gf.setDate(easter.getDate()-2); // Pátek
  const em = new Date(easter); em.setDate(easter.getDate()+1); // Pondělí
  return (gf.getDate()==d && gf.getMonth()+1==m) || (em.getDate()==d && em.getMonth()+1==m);
}
async function fetchNameday(){
  const today = new Date();
  const y=today.getFullYear(), m=pad2(today.getMonth()+1), d=pad2(today.getDate());
  const cacheKey="nameday_"+y+m+d;
  const cached = localStorage.getItem(cacheKey);
  if(cached){ $('#nameday').textContent="Svátek: "+cached; return; }
  try{
    const res = await fetch(PROXY_RAW + encodeURIComponent(`https://svatkyapi.cz/api/day?date=${y}-${m}-${d}`));
    const data = await res.json();
    let txt = (Array.isArray(data)&&data[0]&&data[0].name)? data[0].name : "—";
    if(isCzechPublicHoliday(today)) txt += " (státní svátek)";
    $('#nameday').textContent = "Svátek: " + txt;
    localStorage.setItem(cacheKey, txt);
  }catch(err){
    let txt = isCzechPublicHoliday(today) ? "(státní svátek)" : "—";
    $('#nameday').textContent = "Svátek: " + txt;
  }
}

/* ================== POČASÍ (Open-Meteo) ================== */
async function fetchWeather(){
  try{
    const resNow = await fetch("https://api.open-meteo.com/v1/forecast?latitude=49.69&longitude=14.01&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe%2FPrague");
    const data = await resNow.json();
    const cur = data.current_weather;
    const w0i = textWeatherIcon(cur.weathercode);
    $('#w0-icon').textContent = w0i;
    $('#w0-temp').textContent = `${cur.temperature.toFixed(1)} °C — ${weatherText(cur.weathercode)}`;
    $('#w0-sub').textContent = `Vítr: ${cur.windspeed} km/h • Směr: ${cur.winddirection}°`;
    $('#small-weather .w-icon').textContent = w0i;
    $('#small-weather .w-main').textContent = `${cur.temperature.toFixed(1)} °C`;

    const dIdx = 1, d2Idx = 2;
    const dMax = data.daily.temperature_2m_max, dMin = data.daily.temperature_2m_min, dCode = data.daily.weathercode;
    const icon1 = textWeatherIcon(dCode[dIdx]), icon2 = textWeatherIcon(dCode[d2Idx]);
    $('#w1-icon').textContent = icon1;
    $('#w1-temp').textContent = `${Math.round(dMin[dIdx])}…${Math.round(dMax[dIdx])} °C — ${weatherText(dCode[dIdx])}`;
    $('#w1-sub').textContent = `Zítra`;
    $('#w2-icon').textContent = icon2;
    $('#w2-temp').textContent = `${Math.round(dMin[d2Idx])}…${Math.round(dMax[d2Idx])} °C — ${weatherText(dCode[d2Idx])}`;
    $('#w2-sub').textContent = `Pozítří`;
  }catch(err){
    $('#w0-temp').textContent = 'Počasí nenahráno';
    $('#w1-temp').textContent = '—';
    $('#w2-temp').textContent = '—';
  }
}

/* ================== JÍDELNÍČEK ================== */
function sanitizeMenu(htmlStr, maxLen=3500){
  let s = htmlStr.replace(/<script[\s\S]*?<\/script>/gi,'').replace(/<style[\s\S]*?<\/style>/gi,'').replace(/<img[^>]*>/gi,'');
  s = s.replace(/<(?!\/?(p|ul|ol|li|h[1-4]|br|strong|em|b|i|a|div|span)[\s>])/gi,'');
  if(s.length>maxLen) s = s.slice(0,maxLen)+'…';
  s = s.replace(/<a\b([^>]*)>/gi,(m,attrs)=>{const href=(attrs.match(/href=["']?([^"'>\s]+)/i)||[])[1]||'#';return `<a href="${href}" target="_blank" style="color:#ffd9b8;text-decoration:underline">`;});
  return s;
}
async function fetchMenu(){
  try{
    const r = await fetch(PROXY_RAW + encodeURIComponent(SCHOOL_MENU_URL), {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const html = await r.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html,'text/html');
    const sel = doc.querySelector('main, article, .entry-content, .post-content, .elementor-widget-container, .content, .wp-block-group');
    const raw = sel ? sel.innerHTML : doc.body.innerHTML;
    const safe = sanitizeMenu(raw);
    $('#obed').innerHTML = safe;
  }catch(e){
    $('#obed').innerHTML = '<em>Nelze načíst jídelníček (CORS/zdroj nedostupný).</em>';
  }
}

/* ================== ODJEZDY (Golemio v2) ================== */
function minutesDiffFromISO(iso){
  const t = new Date(iso); const now = new Date();
  return Math.round((t - now)/60000);
}
function fmtDelay(d){
  if(typeof d!=='number' || isNaN(d)) return `<span class="delay na">—</span>`;
  if(d===0) return `<span class="delay zero">+0</span>`;
  if(d>0) return `<span class="delay plus">+${d}</span>`;
  return `<span class="delay">-${Math.abs(d)}</span>`;
}
async function fetchDepartures(){
  const wrap = $('#departures');
  wrap.innerHTML = '';
  for(const s of STOPS){
    const block = document.createElement('div');
    block.className = 'stopBlock';
    block.innerHTML = `
      <div class="stopHead">
        <div class="stopName"><i class="fa-solid fa-location-dot" style="color:var(--accent)"></i> ${s.name}</div>
        <div class="meta">ID: ${s.id}</div>
      </div>
      <div class="stopList"><div class="meta">Načítám…</div></div>
    `;
    wrap.appendChild(block);
    const list = block.querySelector('.stopList');

    try{
      const url = `${PID_BASE}?ids=${encodeURIComponent(s.id)}&minutesBefore=0&minutesAfter=90&limit=10&order=soonest`;
      const res = await fetch(url,{headers:{'x-access-token': PID_TOKEN}});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const rows = (data.departures || data) || [];
      list.innerHTML = '';
      if(rows.length===0){
        list.innerHTML = `<div class="meta">Žádné blízké odjezdy.</div>`;
        continue;
      }
      rows.forEach(d=>{
        const line = (d.route && d.route.short_name) || d.line && d.line.name || d.route_id || '—';
        const dir = d.trip && d.trip.headsign || d.headsign || (d.route && d.route.long_name) || '—';
        const when = d.departure_timestamp && d.departure_timestamp.planned || d.planned_departure || d.departure_time || d.expected_departure_time || null;
        const sched = when ? new Date(when) : null;
        const timeStr = sched ? `${pad2(sched.getHours())}:${pad2(sched.getMinutes())}` : '—';
        const mins = when ? minutesDiffFromISO(when) : null;
        const delaySec = (d.departure_timestamp && d.departure_timestamp.delay) || d.delay || 0;
        const delayMin = Math.round((delaySec||0)/60);

        const row = document.createElement('div');
        row.className = 'depRow';
        row.innerHTML = `
          <div class="line">${line}</div>
          <div class="dir">${dir}</div>
          <div class="time">${timeStr}${(mins!==null?` • za ${mins} min`:'')}</div>
          <div class="delay">${fmtDelay(delayMin)}</div>
        `;
        list.appendChild(row);
      });

    }catch(err){
      list.innerHTML = `<div class="meta">Chyba při načítání (zast.: ${s.id}). ${err.message||err}</div>`;
    }
  }
}

/* ================== TICKER (smooth R→L) ================== */
let tickerX = 0;
function initTicker(){
  const lane = $('#ticker-lane');
  const base = lane.innerHTML;
  // duplikace obsahu pro plynulou smyčku
  lane.innerHTML = base + base + base;
  function step(){
    tickerX -= 0.5; // rychlost
    const w = lane.scrollWidth / 3;
    if(-tickerX >= w) tickerX += w;
    lane.style.transform = `translateX(${tickerX}px)`;
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ================== REFRESH CYCLE ================== */
async function refreshAll(){
  updateClock();
  updateLesson();
  fetchWeather();
  fetchMenu();
  fetchDepartures();
  fetchNameday();
  setMetaStatus();
}
refreshAll();
setInterval(refreshAll, REFRESH_MIN*60*1000);

/* init on load */
window.addEventListener('load', ()=>{ initTicker(); });

/* bezpečnost: reload dat při návratu do viditelnosti */
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refreshAll(); });
</script>
</body>
</html>
